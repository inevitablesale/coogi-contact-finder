(()=>{var T=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,a)=>(typeof require<"u"?require:t)[a]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var g=T("@supabase/supabase-js"),_="https://dbtdplhlatnlzcvdvptn.supabase.co",c=null,h=null,b=null,w=!1,u=!1,d=!1,m=[];function y(e){c=(0,g.createClient)(_,{global:{headers:{Authorization:`Bearer ${e}`}}})}chrome.runtime.onMessage.addListener(async(e,t,a)=>{if(e.type==="SET_TOKEN"&&(h=e.token,b=e.userId,y(h),w||(S(),w=!0,console.log("\u2705 Subscribed to Supabase changes")),a({status:"Token received"})),e.action==="scrapedData"){let{taskId:o,contacts:r,error:l}=e;if(l)console.error(`\u274C Scraping error for task ${o}: ${l}`),await i(o,"error",l),await p(o,l),chrome.action.setBadgeText({text:"ERR"});else try{let{error:s}=await c.from("contacts").insert(r.map(n=>({opportunity_id:n.opportunityId,name:n.name,job_title:n.title,linkedin_profile_url:n.profileUrl,email:n.email||null})));if(s)throw s;await i(o,"complete"),chrome.action.setBadgeText({text:""}),console.log(`\u2705 Task ${o} completed with ${r.length} contacts`)}catch(s){console.error(`\u274C DB error for task ${o}: ${s.message}`),await p(o,s.message),await i(o,"error",s.message)}t.tab?.id&&chrome.tabs.remove(t.tab.id),u=!1,k(),setTimeout(()=>f(),1e3)}});function S(){c.channel("contact_enrichment_tasks").on("postgres_changes",{event:"INSERT",schema:"public",table:"contact_enrichment_tasks"},async e=>{let t=e.new;t.status==="pending"&&t.user_id===b&&$(t)}).subscribe()}function $(e){m.push(e),f()}async function f(){if(u||d||m.length===0)return;let e=m.shift();await x(e)}async function x(e){let{company_name:t,id:a}=e;try{u=!0,chrome.action.setBadgeText({text:"RUN"}),await i(a,"processing");let o=`https://www.linkedin.com/search/results/people/?keywords=${encodeURIComponent(t)}`,r=await chrome.tabs.create({url:o,active:!1});await I(3e3,6e3),await chrome.scripting.executeScript({target:{tabId:r.id},files:["content.js"]}),chrome.tabs.sendMessage(r.id,{action:"scrapeEmployees",company:t,taskId:a,opportunityId:e.opportunity_id})}catch(o){console.error(`\u274C Task ${a} failed: ${o.message}`),await i(a,"error",o.message),await p(a,o.message),chrome.action.setBadgeText({text:"ERR"}),u=!1,k()}}async function i(e,t,a=null){await c.from("contact_enrichment_tasks").update({status:t,error_message:a}).eq("id",e)}async function p(e,t,a=null){await c.from("scrape_logs").insert([{task_id:e,message:t,page_number:a,created_at:new Date().toISOString()}])}function I(e,t){return new Promise(a=>setTimeout(a,Math.floor(Math.random()*(t-e+1))+e))}function k(){d=!0;let e=Math.floor(Math.random()*60001)+3e4;console.log(`\u23F3 Cooldown for ${e/1e3}s`),setTimeout(()=>{d=!1,f()},e)}})();
//# sourceMappingURL=background.js.map
